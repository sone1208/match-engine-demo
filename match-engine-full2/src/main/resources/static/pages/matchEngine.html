<!DOCTYPE html><html><head>    <!-- 页面meta -->    <meta charset="utf-8">    <meta http-equiv="X-UA-Compatible" content="IE=edge">    <title>交易撮合系统</title>    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport">    <!-- 引入样式 -->    <link rel="stylesheet" href="../plugins/elementui/index.css">    <link rel="stylesheet" href="../plugins/font-awesome/css/font-awesome.min.css">    <link rel="stylesheet" href="../css/style.css">    <style>        div {        }        .divHeader {            width: 125px;            height: 30px;            font-family: 幼圆;            font-size: 30px;            font-weight: 900;            padding: 15px 15px 15px 15px;        }        .addOrder {            position: absolute;            top: 50px;            left: 50px;            width: 300px;            height: 300px;            border: 1px solid black;        }        .addOrderButton {            position: absolute;            top: 245px;            left: 65px;        }        .nowUser {            position: absolute;            top: 351px;            left: 50px;            width: 300px;            height: 200px;            border: 1px solid black;            font-family: WenQuanYi Micro Hei;            font-size: 30px;            font-weight: 900;        }        .userBook {            position: absolute;            top: 552px;            left: 50px;            width: 300px;            height: 300px;            border: 1px solid black;        }        .orderBook {            position: absolute;            top: 50px;            left: 351px;            width: 400px;            height: 400px;            border: 1px solid black;        }        .takeOrder {            position: absolute;            top: 451px;            left: 351px;            width: 981px;            height: 400px;            border: 1px solid black;        }        .matchOrder {            position: absolute;            top: 50px;            left: 752px;            width: 580px;            height: 400px;            border: 1px solid black;        }    </style></head><body><div id="app">    <!-- 新增窗口 -->    <div class="addOrder" >        <div class="divHeader">            新增订单        </div>        <el-form ref="orderAddForm" :model="formData" :rules="rules" label-width="100px">            <el-row>                <el-col :span="20">                    <el-form-item label="股票代码" prop="stkcode">                        <el-select v-model="formData.stkcode" @change="changeStock" ref="select">                            <el-option                                    v-for="(item, index) in stockList"                                    :label="item.stkcode"                                    :value="item.stkcode"                                    :key="index"                            >                            </el-option>                        </el-select>                    </el-form-item>                </el-col>            </el-row>            <el-row>                <el-col :span="20">                    <el-form-item label="交易价格" prop="price">                        <el-input v-model="formData.price"                                  onkeyup="this.value=this.value.match(/\d+\.?\d{0,2}/)"                                  onafterpaste="this.value=this.value.match(/\d+\.?\d{0,2}/)"/>                    </el-form-item>                </el-col>            </el-row>            <el-row>                <el-col :span="20">                    <el-form-item label="交易数量" prop="originqty">                        <el-input v-model="formData.originqty"                                  oninput="value=value.replace(/[^\d]/g,'')"/>                    </el-form-item>                </el-col>            </el-row>        </el-form>        <div class="addOrderButton">            <el-row>                <el-button type="primary" @click="addBuyOrder()">买入</el-button>                <el-button type="success" @click="addSellOrder()">卖出</el-button>            </el-row>        </div>    </div>    <!-- 当前用户 -->    <div class="nowUser">        当前用户id：<br>        <div v-text="user.get('userid')"></div>        当前用户名称：<br>        <div v-text="user.get('username')"></div>    </div>    <!-- 用户列表 -->    <div class="userBook">        <div class="divHeader">            用户列表        </div>        <el-table size="small" current-row-key="id" :data="userList"                  stripe highlight-current-row @row-click="changeUser"                  style="overflow-y:auto;height: 237px;">            <el-table-column prop="userid" label="用户id" align="center"></el-table-column>            <el-table-column prop="username" label="用户名称" align="center"></el-table-column>        </el-table>    </div>    <!-- 订阅行情快照 -->    <div class="orderBook">        <div class="divHeader">            行情快照        </div>        <el-table size="small" current-row-key="orderid" :data="subscribedOrderList" stripe highlight-current-row                  style="overflow-y:auto;height: 340px;" :cell-style="{padding: '3px'}">            <el-table-column prop="bsflag" label="委托" align="center"                             :formatter="subscribedOrderDirectionTypeFormatter"></el-table-column>            <el-table-column prop="stkcode" label="股票代码" align="center"></el-table-column>            <el-table-column prop="price" label="交易价格" align="center"></el-table-column>            <el-table-column prop="qty" label="交易数量" align="center"></el-table-column>        </el-table>    </div>    <!-- 用户的委托 -->    <div class="takeOrder">        <div class="divHeader">            用户委托        </div>        <el-table size="small" current-row-key="id" :data="takerOrderList" stripe highlight-current-row                  style="overflow-y:auto;height: 337px;white-space: pre-wrap;">            <el-table-column prop="orderdate,ordertime" label="创建时间" align="center">                <template slot-scope="scope">                    {{scope.row.orderdate}}<br>{{scope.row.ordertime}}                </template>            </el-table-column>            <el-table-column prop="stkcode" label="股票代码" align="center"></el-table-column>            <el-table-column prop="bsflag" label="买卖类型" align="center"                             :formatter="orderDirectionTypeFormatter"></el-table-column>            <el-table-column prop="price" label="订单价格" align="center"></el-table-column>            <el-table-column prop="originqty" label="订单数量" align="center"></el-table-column>            <el-table-column prop="qty" label="已交易数量" align="center"                             :formatter="doneVolFormatter"></el-table-column>            <el-table-column prop="status" label="订单状态" align="center"                             :formatter="takerOrderStatusTypeFormatter"></el-table-column>            <el-table-column label="操作" align="center">            <template slot-scope="scope">                <el-button type="danger" size="mini" :disabled="scope.row.status != 1 && scope.row.status != 4"                           @click="cancelOrder(scope.row)">撤单</el-button>            </template>            </el-table-column>        </el-table>    </div>    <!-- 成交记录 -->    <div class="matchOrder">        <div class="divHeader">            成交记录        </div>        <el-table size="small" current-row-key="id" :data="matchOrderList" stripe highlight-current-row                  style="overflow-y:auto;height: 337px;">            <el-table-column prop="stkcode" label="股票代码" align="center"></el-table-column>            <el-table-column prop="price" label="成交价格" align="center"></el-table-column>            <el-table-column prop="qty" label="成交数量" align="center"></el-table-column>            <el-table-column prop="bsflag" label="买卖类型" align="center"                             :formatter="orderDirectionTypeFormatter"></el-table-column>            <el-table-column prop="makerid" label="交易用户id" align="center"></el-table-column>            <el-table-column prop="tradingdate,tradingtime" label="成交时间" align="center">                <template slot-scope="scope">                    {{scope.row.tradingdate}}<br>{{scope.row.tradingtime}}                </template>            </el-table-column>        </el-table>    </div></div></body><!-- 引入组件库 --><script src="../js/vue.js"></script><script src="../plugins/elementui/index.js"></script><script type="text/javascript" src="../js/jquery.min.js"></script><script src="../js/axios-0.18.0.js"></script><script type="module">    import webSocket from "../js/webSocket.js";    var vm = new Vue({        el:'#app',        data:function(){            return{                webSocketObject: null,                user: {},                currentShareRow: null,                formData: {},//表单数据                userList: [],//当前存在的用户数据                stockList: [],//当前存在的股票列表                takerOrderList: [],//当前用户的委托                matchOrderList: [],//当前用户的成交记录                subscribedOrderList: [],//当前股票的订阅行情                rules: {//校验规则                    price: [{ required: true, message: '交易价格为必填项', trigger: 'blur' }],                    shareid: [{ required: true, message: '股票代码为必填项', trigger: 'blur' }],                    originqty: [{ required: true, message: '交易数量为必填项', trigger: 'blur' }]                }            }        },        created() {            this.setWebSocket();            this.getUsers();            this.user = new FormData();        },        methods:{            setWebSocket() {                // webSocket.webSocketInit(process.env.VUE_APP_BASE_API.replace("http","ws")+"/evgis/todoStatus")                webSocket.webSocketInit('ws://127.0.0.1:8888/websocket')	//初始化webSocket                // 按需进行绑定回调函数                webSocket.setOpenCallback(res=>{                    console.log("连接建立成功",res);                })                webSocket.setMessageCallback(res=>{                    var data = JSON.parse(res.data);                    console.log("接收到后台消息", data);                    switch (data["topic"]) {                        case "subscribedOrders":                            this.subscribedOrderList = data["resData"];                            break;                        case "takerOrders":                            this.takerOrderList = data["resData"];                            break;                        case "tradingRecords":                            this.matchOrderList = data["resData"];                            break;                        default :                            console.log("错误的websocket消息" + data["topic"]);                    }                })                webSocket.setErrorCallback(res=>{                    console.log("连接异常",res);                })                webSocket.setCloseCallback(res=>{                    console.log("连接关闭",res);                })            },            getUsers() {                axios.get("/users").then((res)=>{                    console.log(res.data)                    this.userList = res.data.resData;                });            },            changeUser(row) {                console.log('clicked row:', row.userid)                webSocket.sendMessage("delUser----");                webSocket.sendMessage("delCode----");                axios.get("/users/"+row.userid).then((res)=>{                    this.formData.stkcode = null;                    this.$set(this.formData,'price', null);                    this.$set(this.formData,'originqty', null);                    this.subscribedOrderList = [];                    this.stockList = res.data.resData.stocks;                    this.takerOrderList = res.data.resData.takerOrders;                    this.matchOrderList = res.data.resData.tradingRecords;                    this.user.set("userid", row.userid);                    this.user.set("username", row.username);                })                webSocket.sendMessage("newUser----"+row.userid);            },            changeStock(row) {                console.log('clicked row:', row);                webSocket.sendMessage("delCode----");                axios.get("/users/"+this.user.get("userid")+'/'+row).then((res)=>{                    this.subscribedOrderList = res.data.resData;                })                webSocket.sendMessage("newCode----"+row);                console.log(this.subscribedOrderList);            },            addBuyOrder() {                console.log("add buy order");                console.log(this.formData);                if (this.user.get("userid") === null) {                    this.$notify({                        title:'错误',                        message:'未选中用户',                        type:'error',                        duration:2000                    })                } else if (this.formData.originqty === null ||                    this.formData.price === null ||                    this.formData.stkcode === null ||                    this.formData.originqty === "" ||                    this.formData.price === "" ||                    this.formData.stkcode === "" ){                    this.$notify({                        title:'错误',                        message:'订单信息不全',                        type:'error',                        duration:2000                    })                } else {                    this.formData.bsflag = true;                    axios.post("/users/"+this.user.get("userid"), this.formData).then((res)=>{                        this.takerOrderList = res.data.resData.takerOrders;                        this.subscribedOrderList = res.data.resData.subscribedOrders;                    })                }            },            addSellOrder() {                console.log("add sell order");                console.log(this.formData);                if (this.user.get("userid") === null) {                    this.$notify({                        title:'失败',                        message:'未选中用户',                        type:'error',                        duration:2000                    })                } else if (this.formData.originqty === null ||                    this.formData.price === null ||                    this.formData.stkcode === null ||                    this.formData.originqty === "" ||                    this.formData.price === "" ||                    this.formData.stkcode === "" ){                    this.$notify({                        title: '失败',                        message: '订单信息不全',                        type: 'error',                        duration: 2000                    })                } else {                    this.formData.bsflag = false;                    axios.post("/users/" + this.user.get("userid"), this.formData).then((res) => {                        this.takerOrderList = res.data.resData.takerOrders;                        this.subscribedOrderList = res.data.resData.subscribedOrders;                    })                }            },            cancelOrder(row) {                console.log('delete order:', row.orderId);                axios.delete("/users/"+this.user.get("userid")+"/"+row.orderid).then((res)=>{                    if (res.data !== null) {                        this.takerOrderList = res.data.resData.takerOrders;                    } else {                        this.$notify({                            title:'错误',                            message:'订单状态发生变化，暂时不能撤单',                            type:'error',                            duration:2000                        })                    }                })            },            subscribedOrderDirectionTypeFormatter(row) {                if (row === null)                    return null;                if (row.bsflag === null)                    return null;                var sellOrderNum = this.subscribedOrderList.length;                var key_id = 0;                for (var i = 0; i < this.subscribedOrderList.length; i++) {                    if (this.subscribedOrderList[i].bsflag === true) {                        sellOrderNum = i;                        break;                    }                }                for (var i = 0; i < this.subscribedOrderList.length; i++) {                    if (this.subscribedOrderList[i].orderid === row.orderid) {                        key_id = i;                        break;                    }                }                let bsflag = row.bsflag;                if (bsflag === true) {                    var res = "买";                    var id = key_id - sellOrderNum;                    switch(id) {                        case 0:                            res = res + "一";                            break;                        case 1:                            res = res + "二";                            break;                        case 2:                            res = res + "三";                            break;                        case 3:                            res = res + "四";                            break;                        case 4:                            res = res + "五";                            break;                        default:                            break;                    }                } else if (bsflag === false) {                    var res = "卖";                    var id = sellOrderNum - key_id - 1;                    switch(id) {                        case 0:                            res = res + "一";                            break;                        case 1:                            res = res + "二";                            break;                        case 2:                            res = res + "三";                            break;                        case 3:                            res = res + "四";                            break;                        case 4:                            res = res + "五";                            break;                        default:                            break;                    }                }                return res;            },            orderDirectionTypeFormatter(row) {                if (row === null)                    return null;                if (row.bsflag === null)                    return null;                let bsflag = row.bsflag;                if (bsflag === true) {                    return "买入"                } else if (bsflag === false) {                    return "卖出"                }            },            takerOrderStatusTypeFormatter(row) {                if (row === null)                    return null;                if (row.status === null)                    return null;                let status = row.status;                switch (status) {                    case 1:                        return "已委托";                    case 2:                        return "正在交易";                    case 3:                        return "正在撤单";                    case 4:                        return "部分交易";                    case 5:                        return "完成交易";                    case 6:                        return "已撤单";                    default:                        return null;                }            },            doneVolFormatter(row) {                if (row === null)                    return null;                if (row.qty === null)                    return null;                if (row.originqty === null)                    return null;                return row.originqty - row.qty;            },        }    });</script></html>