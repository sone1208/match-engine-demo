<!DOCTYPE html><html><head>    <!-- 页面meta -->    <meta charset="utf-8">    <meta http-equiv="X-UA-Compatible" content="IE=edge">    <title>交易撮合系统</title>    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport">    <!-- 引入样式 -->    <link rel="stylesheet" href="../plugins/elementui/index.css">    <link rel="stylesheet" href="../plugins/font-awesome/css/font-awesome.min.css">    <link rel="stylesheet" href="../css/style.css">    <style>        div {        }        .divHeader {            width: 125px;            height: 30px;            font-family: 幼圆;            font-size: 30px;            font-weight: 900;            padding: 15px 15px 15px 15px;        }        .addOrder {            position: absolute;            top: 50px;            left: 50px;            width: 300px;            height: 300px;            border: 1px solid black;        }        .addOrderButton {            position: absolute;            top: 245px;            left: 65px;        }        .shareBook {            position: absolute;            top: 351px;            left: 50px;            width: 300px;            height: 200px;            border: 1px solid black;        }        .userBook {            position: absolute;            top: 552px;            left: 50px;            width: 300px;            height: 300px;            border: 1px solid black;        }        .orderBook {            position: absolute;            top: 50px;            left: 351px;            width: 400px;            height: 400px;            border: 1px solid black;        }        .takeOrder {            position: absolute;            top: 451px;            left: 351px;            width: 801px;            height: 400px;            border: 1px solid black;        }        .matchOrder {            position: absolute;            top: 50px;            left: 752px;            width: 400px;            height: 400px;            border: 1px solid black;        }    </style></head><body><div id="app">    <!-- 新增窗口 -->    <div class="addOrder" >        <div class="divHeader">            新增订单        </div>        <el-form ref="orderAddForm" :model="formData" :rules="rules" label-width="100px">            <el-row>                <el-col :span="20">                    <el-form-item label="股票类别" prop="share_id">                        <el-input v-model="formData.share_id"/>                    </el-form-item>                </el-col>            </el-row>            <el-row>                <el-col :span="20">                    <el-form-item label="交易数量" prop="origin_amount">                        <el-input v-model="formData.origin_amount"                                  oninput="value=value.replace(/[^\d]/g,'')">                    </el-form-item>                </el-col>            </el-row>            <el-row>                <el-col :span="20">                    <el-form-item label="交易价格" prop="price">                        <el-input v-model="formData.price"                                  onkeyup="this.value=this.value.match(/\d+\.?\d{0,2}/)"                                  onafterpaste="this.value=this.value.match(/\d+\.?\d{0,2}/)"/>                    </el-form-item>                </el-col>            </el-row>        </el-form>        <div class="addOrderButton">            <el-row>                <el-button type="primary" @click="addBuyOrder()">买入</el-button>                <el-button type="success" @click="addSellOrder()">卖出</el-button>            </el-row>        </div>    </div>    <!-- 用户列表 -->    <div class="userBook">        <div class="divHeader">            用户列表        </div>        <el-table size="small" current-row-key="id" :data="userList"                  stripe highlight-current-row @row-click="changeUser"                  style="overflow-y:auto;height: 237px;">            <el-table-column prop="user_id" label="用户id" align="center"></el-table-column>            <el-table-column prop="user_name" label="用户名称" align="center"></el-table-column>        </el-table>    </div>    <!-- 持有股票列表 -->    <div class="shareBook">        <div class="divHeader">            订阅股票        </div>        <el-table size="small" current-row-key="id" ref="shareBook"                  :show-header=false :data="shareList"                  stripe highlight-current-row  @row-click="changeShare"                  style="overflow-y:auto;height: 137px;">            <el-table-column label="股票id" align="left">                <template slot-scope="scope">                    {{scope.row}}                </template>            </el-table-column>        </el-table>    </div>    <!-- 订阅行情快照 -->    <div class="orderBook">        <div class="divHeader">            行情快照        </div>        <el-table size="small" current-row-key="order_id" :data="subscribedOrderList" stripe highlight-current-row                  style="overflow-y:auto;height: 340px;" :cell-style="{padding: '3px'}">            <el-table-column prop="direction" label="委托" align="center"                             :formatter="subscribedOrderDirectionTypeFormatter"></el-table-column>            <el-table-column prop="share_id" label="股票类别" align="center"></el-table-column>            <el-table-column prop="price" label="交易价格" align="center"></el-table-column>            <el-table-column prop="amount" label="交易数量" align="center"></el-table-column>        </el-table>    </div>    <!-- 用户的委托 -->    <div class="takeOrder">        <div class="divHeader">            用户委托        </div>        <el-table size="small" current-row-key="id" :data="takerOrderList" stripe highlight-current-row                  style="overflow-y:auto;height: 337px;">            <el-table-column prop="share_id" label="股票类别" align="center"></el-table-column>            <el-table-column prop="direction" label="买卖类型" align="center"                             :formatter="takerOrderDirectionTypeFormatter"></el-table-column>            <el-table-column prop="price" label="交易价格" align="center"></el-table-column>            <el-table-column prop="origin_amount" label="交易数量" align="center"></el-table-column>            <el-table-column prop="amount" label="剩余数量" align="center"></el-table-column>            <el-table-column label="操作" align="center">            <template slot-scope="scope">                <el-button type="danger" size="mini" @click="cancelOrder(scope.row)">删除</el-button>            </template>            </el-table-column>        </el-table>    </div>    <!-- 成交记录 -->    <div class="matchOrder">        <div class="divHeader">            成交记录        </div>        <el-table size="small" current-row-key="id" :data="matchOrderList" stripe highlight-current-row                  style="overflow-y:auto;height: 337px;">            <el-table-column prop="shareId" label="股票类别" align="center"></el-table-column>            <el-table-column prop="price" label="交易价格" align="center"></el-table-column>            <el-table-column prop="amount" label="交易数量" align="center"></el-table-column>        </el-table>    </div></div></body><!-- 引入组件库 --><script src="../js/vue.js"></script><script src="../plugins/elementui/index.js"></script><script type="text/javascript" src="../js/jquery.min.js"></script><script src="../js/axios-0.18.0.js"></script><script type="module">    import webSocket from "../js/webSocket.js";    var vm = new Vue({        el:'#app',        data:function(){            return{                webSocketObject: null,                user: {},                currentShareRow: null,                formData: {},//表单数据                userList: [],//当前存在的用户数据                shareList: [],//当前用户的持有股票                subscribedOrderListMap: [],//当前用户的订阅行情map                subscribedOrderList: [],//当前用户当前股票的订阅行情                takerOrderList: [],//当前用户的委托                matchOrderList: [],//当前用户的成交记录                rules: {//校验规则                    price: [{ required: true, message: '交易价格为必填项', trigger: 'blur' }],                    share_id: [{ required: true, message: '股票类别为必填项', trigger: 'blur' }],                    origin_amount: [{ required: true, message: '交易数量为必填项', trigger: 'blur' }]                }            }        },        created() {            this.setWebSocket();            this.getUsers();            this.user = new FormData();        },        methods:{            setWebSocket() {                // webSocket.webSocketInit(process.env.VUE_APP_BASE_API.replace("http","ws")+"/evgis/todoStatus")                webSocket.webSocketInit('ws://127.0.0.1:8888/websocket')	//初始化webSocket                // 按需进行绑定回调函数                webSocket.setOpenCallback(res=>{                    console.log("连接建立成功",res);                })                webSocket.setMessageCallback(res=>{                    console.log("接收到后台消息", res);                    if (this.user.get("user_id") !== null) {                        axios.get("/users/"+this.user.get("user_id")).then((res)=>{                            this.updateOrders(res);                        })                    }                })                webSocket.setErrorCallback(res=>{                    console.log("连接异常",res);                })                webSocket.setCloseCallback(res=>{                    console.log("连接关闭",res);                })            },            getUsers() {                axios.get("/users").then((res)=>{                    console.log(res.data)                    this.userList = res.data;                });            },            changeUser(row, column, event) {                console.log('clicked row:', row.user_id)                axios.get("/users/"+row.user_id).then((res)=>{                    this.$refs.shareBook.setCurrentRow(-1);                    this.currentShareRow = null;                    this.subscribedOrderList = [];                    this.updateOrders(res);                    this.user.set("user_id", row.user_id);                })            },            changeShare(row, column, event) {                console.log('clicked row:', row);                this.subscribedOrderList = this.subscribedOrderListMap[row];                this.currentShareRow = row;                console.log(this.subscribedOrderList);            },            addBuyOrder() {                console.log("add buy order");                console.log(this.formData);                if (this.user.get("user_id") === null) {                    this.$notify({                        title:'错误',                        message:'未选中用户',                        type:'error',                        duration:2000                    })                } else if (typeof(this.formData.origin_amount) == "undefined" ||                            typeof(this.formData.price) == "undefined" ||                            typeof(this.formData.share_id) == "undefined" ||                            this.formData.origin_amount === "" ||                            this.formData.price === "" ||                            this.formData.share_id === "" ){                    this.$notify({                        title:'错误',                        message:'订单信息不全',                        type:'error',                        duration:2000                    })                } else {                    axios.post("/users/"+this.user.get("user_id")+"/0", this.formData).then((res)=>{                        this.updateOrders(res);                    })                }            },            addSellOrder() {                console.log("add sell order");                console.log(this.formData);                if (this.user.get("user_id") === null) {                    this.$notify({                        title:'失败',                        message:'未选中用户',                        type:'error',                        duration:2000                    })                } else if (typeof(this.formData.origin_amount) == "undefined" ||                    typeof(this.formData.price) == "undefined" ||                    typeof(this.formData.share_id) == "undefined" ||                    this.formData.origin_amount === "" ||                    this.formData.price === "" ||                    this.formData.share_id === "" ) {                    this.$notify({                        title: '失败',                        message: '订单信息不全',                        type: 'error',                        duration: 2000                    })                } else {                    axios.post("/users/" + this.user.get("user_id") + "/1", this.formData).then((res) => {                        this.updateOrders(res);                    })                }            },            cancelOrder(row) {                console.log('delete order:', row.order_id);                axios.delete("/users/"+this.user.get("user_id")+"/"+row.order_id).then((res)=>{                    this.updateOrders(res);                })            },            updateOrders(res) {                this.shareList = res.data.subscribedShares;                this.subscribedOrderListMap = res.data.subscribedOrders;                if (this.currentShareRow !== null) {                    this.subscribedOrderList = this.subscribedOrderListMap[this.currentShareRow];                }                this.takerOrderList = res.data.takerOrders;                this.matchOrderList = res.data.matchOrders;            },            subscribedOrderDirectionTypeFormatter(row) {                if (row === null)                    return null;                if (row.direction === null)                    return null;                var sellOrderNum = this.subscribedOrderList.length;                var key_id = 0;                for (var i = 0; i < this.subscribedOrderList.length; i++) {                    if (this.subscribedOrderList[i].direction === 'BUY') {                        sellOrderNum = i;                        break;                    }                }                for (var i = 0; i < this.subscribedOrderList.length; i++) {                    if (this.subscribedOrderList[i].order_id === row.order_id) {                        key_id = i;                        break;                    }                }                let direction = row.direction;                if (direction === 'BUY') {                    var res = "买";                    var id = key_id - sellOrderNum;                    switch(id) {                        case 0:                            res = res + "一";                            break;                        case 1:                            res = res + "二";                            break;                        case 2:                            res = res + "三";                            break;                        case 3:                            res = res + "四";                            break;                        case 4:                            res = res + "五";                            break;                        default:                            break;                    }                } else if (direction === 'SELL') {                    var res = "卖";                    var id = sellOrderNum - key_id - 1;                    switch(id) {                        case 0:                            res = res + "一";                            break;                        case 1:                            res = res + "二";                            break;                        case 2:                            res = res + "三";                            break;                        case 3:                            res = res + "四";                            break;                        case 4:                            res = res + "五";                            break;                        default:                            break;                    }                }                return res;            },            takerOrderDirectionTypeFormatter(row) {                if (row === null)                    return null;                if (row.direction === null)                    return null;                let direction = row.direction;                if (direction === 'BUY') {                    return "买入"                } else if (direction === 'SELL') {                    return "卖出"                }            },        }    });</script></html>